$userUPN = "username@contoso.com"
$aadUser = "AzureAD\$userUPN"; try {$sid = (New-Object System.Security.Principal.NTAccount($aadUser)).Translate([System.Security.Principal.SecurityIdentifier]).Value; Write-Host "User SID is: $sid";} catch { Write-Error "Could not resolve SID for $aadUser"; exit;}; $infPath = "$env:TEMP\secpol.inf"; $seceditDbPath = "$env:TEMP\secedit.sdb"; secedit /export /cfg $infPath /areas USER_RIGHTS; $inf = Get-Content $infPath; $policyLine = "SeDenyInteractiveLogonRight"; $policySet = $false; for ($i = 0; $i -lt $inf.Count; $i++) {if ($inf[$i] -match "^$policyLine\s*=") {if ($inf[$i] -notmatch $sid) {$inf[$i] += ",$sid";} $policySet = $true; break;}}; if (-not $policySet) {$privIndex = $inf.IndexOf("[Privilege Rights]"); if ($privIndex -ge 0) {$inf = $inf[0..$privIndex] + "$policyLine = $sid" + $inf[($privIndex + 1)..($inf.Count - 1)];} else {$inf += "[Privilege Rights]";$inf += "$policyLine = $sid";}}; $inf | Set-Content $infPath -Encoding Unicode ; secedit /configure /db $seceditDbPath /cfg $infPath /areas USER_RIGHTS /quiet ; Remove-Item $infPath -Force ; Remove-Item $seceditDbPath -Force ; Write-Host "Deny logon policy applied to $userUPN" ;